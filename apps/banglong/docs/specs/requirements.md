# 交屋手冊密碼保護與文件管理系統 - Requirements Document

為前台 /service/handbook 頁面新增密碼保護的交屋手冊功能,包含手冊封面列表展示、密碼驗證、多文件下載管理,以及對應的後台 CRUD 介面。此功能需要重構現有數據模型以支持一個手冊包含多個文件的需求。

## Core Features

### 1. 前台功能 (`/service/handbook`)

**1.1 頁面頂部文字區塊**
- 固定顯示客戶歡迎詞與操作說明
- 內容:
  ```
  親愛的邦瓏客戶:
  感謝您惠購置本公司所興建之大廈!
  相關交屋作業流程注意事務請點選個案別後,點選你所需要的資訊查詢參考!
  若仍不足以提供您足夠資訊請逕洽您的業務行政專員,本公司將會提供您最充分的資訊及服務,謝謝!
  ```

**1.2 手冊封面列表 (網格佈局)**
- 以網格方式展示所有啟用的交屋手冊封面
- 每個手冊顯示:
  - 封面圖片
  - 手冊標題 (格式: `{專案名稱}︱交屋手冊`)
- 點擊封面進入手冊詳情頁

**1.3 手冊詳情頁**
- URL 格式: `/service/handbook/[handbookId]`
- 頁面元素:
  - 封面圖片展示
  - 手冊標題
  - 密碼輸入欄位
  - "進入手冊" 按鈕
- 密碼驗證:
  - 使用者輸入密碼後驗證
  - 驗證成功: 顯示文件列表區域
  - 驗證失敗: 顯示錯誤提示 "密碼錯誤,請重新輸入"
  - 已驗證過的手冊在當前 session 中無需重複輸入密碼

**1.4 文件列表與下載**
- 密碼驗證通過後顯示該手冊下所有文件
- 每個文件顯示:
  - 文件名稱
  - 文件類型圖標 (PDF/DOC/DOCX/PPT/PPTX)
  - 文件大小 (可選)
  - 下載按鈕
- 點擊下載:
  - 開始文件下載
  - 記錄下載次數

### 2. 後台功能 (`/admin/handbooks`)

**2.1 手冊列表頁**
- 顯示所有交屋手冊 (包含啟用/停用)
- 列表欄位:
  - 封面縮圖
  - 手冊標題
  - **所屬專案** (顯示專案名稱,可為空)
  - 密碼 (遮罩顯示,如 `****`)
  - 文件數量
  - 下載總次數
  - 狀態 (啟用/停用)
  - 排序順序
  - 操作按鈕 (編輯/刪除/查看文件)
- 功能:
  - 新增手冊
  - 搜尋手冊 (可按標題或專案名稱搜尋)
  - **專案篩選** (下拉選單篩選特定專案的手冊,或顯示全部)
  - 批次操作 (啟用/停用)
  - 拖曳排序

**2.2 新增/編輯手冊**
- 表單欄位:
  - **所屬專案** (下拉選單,可選擇現有專案或留空)
  - 手冊標題 (必填)
  - 封面圖片上傳 (必填)
  - 密碼設定 (必填,建議 6-8 位數字)
  - 描述 (可選)
  - 排序順序
  - 是否啟用
- 儲存後進入文件管理頁面
- **關聯邏輯**:
  - 可選擇現有專案關聯 (一個專案可關聯多個手冊)
  - 也可不關聯專案 (獨立手冊)
  - 已關聯專案的手冊,封面可選擇使用專案封面或自訂上傳

**2.3 手冊文件管理**
- URL: `/admin/handbooks/[handbookId]/files`
- 功能:
  - 顯示該手冊下所有文件列表
  - 上傳新文件 (支援 PDF, DOC, DOCX, PPT, PPTX)
  - 編輯文件資訊:
    - 文件顯示名稱
    - 排序順序
  - 刪除文件
  - 查看各文件下載次數
  - 拖曳排序文件

## User Stories

### 前台使用者 (邦瓏客戶)

1. **查看手冊列表**
   - As a 邦瓏客戶, I want 在 /service/handbook 頁面看到所有可用的交屋手冊封面, so that 我可以快速找到自己專案的手冊

2. **密碼保護存取**
   - As a 邦瓏客戶, I want 使用密碼保護手冊內容, so that 只有購買該專案的客戶才能查看相關資料

3. **下載交屋文件**
   - As a 邦瓏客戶, I want 密碼驗證通過後可以下載多個交屋相關文件, so that 我可以離線查閱重要資訊

4. **免重複輸入密碼**
   - As a 邦瓏客戶, I want 在同一次瀏覽期間不需要重複輸入相同手冊的密碼, so that 我可以更方便地瀏覽文件

### 後台管理員

5. **管理手冊與專案關聯**
   - As an 後台管理員, I want 建立交屋手冊時可選擇關聯到特定專案, so that 我可以為不同專案提供客製化的交屋資訊
   - As an 後台管理員, I want 在手冊列表中按專案篩選, so that 我可以快速找到特定專案的所有手冊

6. **上傳多個文件**
   - As an 後台管理員, I want 為一個手冊上傳多個不同格式的文件, so that 客戶可以獲得完整的交屋資料包

7. **追蹤下載數據**
   - As an 後台管理員, I want 查看各文件的下載次數, so that 我可以了解哪些資訊最受客戶關注

8. **控制顯示順序**
   - As an 後台管理員, I want 調整手冊和文件的排序, so that 重要或最新的資訊可以優先展示

9. **獨立手冊管理**
   - As an 後台管理員, I want 建立不關聯任何專案的獨立手冊, so that 我可以提供通用的交屋指南或公司政策文件

## Acceptance Criteria

### 前台功能

- [ ] `/service/handbook` 頁面頂部正確顯示固定文字區塊
- [ ] 手冊封面以響應式網格佈局展示 (手機 2欄, 平板 3欄, 桌面 3-4欄)
- [ ] 點擊封面可正確跳轉到手冊詳情頁 `/service/handbook/[id]`
- [ ] 詳情頁正確顯示封面圖、標題、密碼輸入欄位
- [ ] 輸入錯誤密碼時顯示錯誤提示
- [ ] 輸入正確密碼後顯示文件列表
- [ ] 文件列表顯示所有已上傳文件,包含名稱、類型圖標
- [ ] 點擊文件可成功下載
- [ ] 下載動作會更新該文件的下載次數
- [ ] 同一 session 中已驗證的手冊無需重複輸入密碼
- [ ] 停用的手冊不顯示在前台列表

### 後台功能

- [ ] `/admin/handbooks` 頁面顯示所有手冊列表
- [ ] **手冊列表顯示所屬專案名稱** (若有關聯)
- [ ] **提供專案篩選下拉選單** (可選擇特定專案或顯示全部)
- [ ] **搜尋功能支援按標題或專案名稱搜尋**
- [ ] 新增手冊時可**選擇關聯的專案** (下拉選單,可留空)
- [ ] 可上傳封面圖片 (或選擇使用專案封面)
- [ ] 可設定手冊密碼 (6-8位數字)
- [ ] 可編輯手冊基本資訊 (標題、封面、密碼、所屬專案、狀態)
- [ ] 可刪除手冊 (需確認對話框)
- [ ] 手冊列表可透過拖曳調整排序
- [ ] 點擊 "管理文件" 可進入該手冊的文件管理頁面
- [ ] 文件管理頁面可上傳新文件 (PDF/DOC/DOCX/PPT/PPTX)
- [ ] 可編輯文件顯示名稱
- [ ] 可刪除文件 (需確認對話框)
- [ ] 文件列表可透過拖曳調整排序
- [ ] 文件列表顯示各文件的下載次數
- [ ] 刪除手冊時會同步刪除所有關聯文件 (cascade delete)
- [ ] 刪除專案時,關聯的手冊 projectId 設為 null (SetNull),手冊資料保留

### 數據模型

- [ ] 新增 `Handbook` 模型,包含: id, title, coverImageUrl, password, **projectId (nullable)**, description, order, isActive, createdAt, updatedAt
- [ ] 新增 `HandbookFile` 模型,包含: id, handbookId, title, fileUrl, fileType, fileSize, order, downloadCount, createdAt, updatedAt
- [ ] `Handbook.projectId` 正確關聯到 `Project.id` (外鍵約束,可為 null)
- [ ] `HandbookFile.handbookId` 正確關聯到 `Handbook.id` (外鍵約束)
- [ ] 刪除 Handbook 時自動刪除關聯的 HandbookFiles (onDelete: Cascade)
- [ ] **刪除 Project 時,關聯的 Handbooks 的 projectId 設為 null (onDelete: SetNull)** - 保護客戶資料不因刪除專案而丟失
- [ ] **關聯關係**: Project (1) → (N) Handbook (1) → (N) HandbookFile

## Non-functional Requirements

### 效能需求

- 前台手冊列表頁面載入時間 < 2秒
- 密碼驗證響應時間 < 500ms
- 文件下載立即開始 (使用直接連結或預簽名 URL)
- 封面圖片使用 lazy loading 優化載入

### 安全需求

- **密碼儲存**: 手冊密碼使用 bcrypt 雜湊儲存,不以明文保存
- **密碼驗證**: 在後端 API 進行驗證,前端不可見密碼雜湊值
- **Session 管理**: 使用 HTTP-only cookie 或 session storage 記錄已驗證的手冊 ID
- **文件存取**: 驗證密碼後才能取得文件下載 URL
- **CSRF 保護**: 上傳和刪除操作需 CSRF token
- **輸入驗證**:
  - 後端驗證上傳文件類型和大小
  - 限制文件大小 (建議 < 50MB)
  - 檔名 sanitization 防止路徑穿越攻擊

### 相容性需求

- 支援現代瀏覽器: Chrome, Firefox, Safari, Edge (最新兩個版本)
- 響應式設計支援手機、平板、桌面裝置
- 文件下載相容 iOS Safari (避免使用 `download` attribute,使用 `window.open`)

### 資料一致性

- 不破壞現有 `Document` 模型和相關功能 (Never break existing features)
- 手冊與文件的關聯使用外鍵約束確保資料完整性
- 刪除操作使用 soft delete 或明確的 cascade delete 避免孤立資料

### 使用者體驗

- 上傳進度提示 (loading spinner)
- 操作成功/失敗的明確提示訊息
- 刪除操作需二次確認
- 空狀態提示 (無手冊時顯示引導文字)
- 錯誤處理友善 (網路錯誤、伺服器錯誤時的提示)
